(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{453:function(t,s,a){"use strict";a.r(s);var n=a(1),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h3",{attrs:{id:"简述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简述"}},[t._v("#")]),t._v(" 简述")]),t._v(" "),s("p",[t._v("Kafka 是⼀个分布式的、⽀持分区的"),s("code",[t._v("partition")]),t._v("、多副本的 "),s("code",[t._v("replica")]),t._v("，基于 zookeeper 协调的分布式消息系统，它最大的特性就是可以实时处理大量数据以满足各类需求场景：")]),t._v(" "),s("ul",[s("li",[t._v("日志收集")]),t._v(" "),s("li",[t._v("消息服务")]),t._v(" "),s("li",[t._v("用户活动跟踪：用来记录用户的各种活动，如浏览网页、搜索、点击等活动，这些活动信息被各个服务器"),s("strong",[t._v("发布到 kafka 的 topic")]),t._v(" 中，然后订阅者通过"),s("strong",[t._v("订阅")]),t._v("这些 topic 来做"),s("strong",[t._v("实时的监控分析")]),t._v("，或者装载到 hadoop、数据仓库中做"),s("strong",[t._v("离线分析和挖掘")])]),t._v(" "),s("li",[t._v("运营监控：用来记录运营监控数据，包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告")])]),t._v(" "),s("h3",{attrs:{id:"相关术语"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#相关术语"}},[t._v("#")]),t._v(" 相关术语")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("名称")]),t._v(" "),s("th",[t._v("解释")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Broker")]),t._v(" "),s("td",[t._v("消息中间件处理节点，⼀个 Kafka 节点就是⼀个 broker，⼀个或者多个 Broker 可以组成⼀个 Kafka 集群")])]),t._v(" "),s("tr",[s("td",[t._v("Topic")]),t._v(" "),s("td",[t._v("Kafka 根据 topic 对消息进行归类，发布到 Kafka 集群的每条消息都需要"),s("strong",[t._v("指定⼀个 topic")])])]),t._v(" "),s("tr",[s("td",[t._v("Producer")]),t._v(" "),s("td",[t._v("消息生产者")])]),t._v(" "),s("tr",[s("td",[t._v("Consumer")]),t._v(" "),s("td",[t._v("消息消费者")])]),t._v(" "),s("tr",[s("td",[t._v("ConsumerGroup")]),t._v(" "),s("td",[t._v("每个 Consumer 属于⼀个特定的 Consumer Group，⼀条消息可以"),s("strong",[t._v("被多个不同的 Consumer Group 消费")]),t._v("，但是⼀个 Consumer Group 中"),s("strong",[t._v("只能有⼀个 Consumer 能够消费该消息")])])]),t._v(" "),s("tr",[s("td",[t._v("Partition")]),t._v(" "),s("td",[t._v("⼀个 topic 可以分为多个 partition，每个 partition 内部消息是"),s("strong",[t._v("有序的")])])]),t._v(" "),s("tr",[s("td",[t._v("Replica")]),t._v(" "),s("td",[t._v("副本")])])])]),t._v(" "),s("h3",{attrs:{id:"核心配置详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心配置详解"}},[t._v("#")]),t._v(" 核心配置详解")]),t._v(" "),s("p",[s("code",[t._v("server.properties")]),t._v("：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Property")]),t._v(" "),s("th",[t._v("Default")]),t._v(" "),s("th",[t._v("Description")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("broker.id")]),t._v(" "),s("td",[t._v("0")]),t._v(" "),s("td",[t._v("broker的名称，集群内唯一")])]),t._v(" "),s("tr",[s("td",[t._v("log.dirs")]),t._v(" "),s("td",[t._v("/temp/kafka-logs")]),t._v(" "),s("td",[t._v("kafka 存放数据的路径，多个路径用"),s("code",[t._v(",")]),t._v("隔开，每当创建新 partition 时，都会选择在包含最少 partitions 的路径下进行")])]),t._v(" "),s("tr",[s("td",[t._v("listeners")]),t._v(" "),s("td",[t._v("PLAINTEXT://192.168.65.60:9092")]),t._v(" "),s("td",[t._v("服务ip和端口")])]),t._v(" "),s("tr",[s("td",[t._v("zookeeper.connect")]),t._v(" "),s("td",[t._v("localhost:2181")]),t._v(" "),s("td",[t._v("如果zk是集群的话："),s("code",[t._v("hostname1:port1")]),t._v("，"),s("code",[t._v("hostname2:port2")]),t._v("，"),s("code",[t._v("hostname3:port3")])])]),t._v(" "),s("tr",[s("td",[t._v("log.retention.hours")]),t._v(" "),s("td",[t._v("168")]),t._v(" "),s("td",[t._v("每个日志文件删除之前保存的时间，默认数据保存时间对所有 topic 都⼀样")])]),t._v(" "),s("tr",[s("td",[t._v("num.partitions")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("创建 topic 的默认分区数")])]),t._v(" "),s("tr",[s("td",[t._v("default.replication.factor")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("⾃动创建 topic 的默认副本数量，建议设置为⼤于等于 2")])]),t._v(" "),s("tr",[s("td",[t._v("min.insync.replicas")]),t._v(" "),s("td",[t._v("1")]),t._v(" "),s("td",[t._v("当 producer 设置 acks 为 -1 时，min.insync.replicas 指定 "),s("strong",[t._v("replicas 的最小数目")]),t._v("（必须确认每⼀个 repica 的写数据都是成功的），如果这个数目"),s("strong",[t._v("没有达到")]),t._v("，producer 发送消息会"),s("strong",[t._v("产生异常")])])]),t._v(" "),s("tr",[s("td",[t._v("delete.topic.enable")]),t._v(" "),s("td",[t._v("false")]),t._v(" "),s("td",[t._v("是否允许删除主题")])])])]),t._v(" "),s("h3",{attrs:{id:"主题和分区"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主题和分区"}},[t._v("#")]),t._v(" 主题和分区")]),t._v(" "),s("p",[t._v("kafka通过topic进行消息分类，不同topic的消息会被订阅该topic的消费者消费；由于topic的消息是被保存在log中，所以这里引进了partition概念，防止消息太多导致log文件过大问题")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/kafka-partition.png",alt:""}})]),t._v(" "),s("p",[t._v("分区作用：")]),t._v(" "),s("ul",[s("li",[t._v("可以分布式存储")]),t._v(" "),s("li",[t._v("可以并行写")])]),t._v(" "),s("p",[s("strong",[t._v("partition细节")]),t._v("：")]),t._v(" "),s("p",[t._v("在消息日志文件中，kafka内部创建了"),s("code",[t._v("_consumer_offsets")]),t._v("主题包含50个分区，这个主题用来存放消费者某个主题的偏移量"),s("code",[t._v("offset")]),t._v("，每个消费者会把消费的主题的偏移量自主上报给kafka的默认主题"),s("code",[t._v("_consumer_offsets")]),t._v("。kafka为了提升这个主题的并发量，默认设置了50个分区：")]),t._v(" "),s("ul",[s("li",[t._v("提交到哪个分区：通过hash函数："),s("code",[t._v("hash(consumerGroupId) % _consumer_offsets")])]),t._v(" "),s("li",[t._v("提交给该主题的内容：key是"),s("code",[t._v("consumerGroupId+topic+分区号")]),t._v("，value是当前offset值")]),t._v(" "),s("li",[t._v("文件保存的消息默认7天，7天后消息会被删除")])]),t._v(" "),s("h3",{attrs:{id:"环境搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环境搭建"}},[t._v("#")]),t._v(" 环境搭建")]),t._v(" "),s("h4",{attrs:{id:"_1-下载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载"}},[t._v("#")]),t._v(" 1.下载")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("http://kafka.apache.org/downloads\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h4",{attrs:{id:"_2-修改server-properties"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改server-properties"}},[t._v("#")]),t._v(" 2.修改server.properties")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# broker.id 属性在 kafka 集群中必须唯一")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("broker.id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kafka 部署的机器 ip 和提供服务的端口号")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("listeners")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("PLAINTEXT://192.168.65.60:9092\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kafka 的消息存储文件")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("log.dir")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/data/kafka-logs\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kafka 连接 zookeeper 的地址")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("zookeeper.connect")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".65.60:2181\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("如果搭建集群则创建多份配置文件："),s("code",[t._v("server0.properties，server1.properties，server2.properties")]),t._v("，"),s("code",[t._v("broker.id=0,1,2")])]),t._v(" "),s("h4",{attrs:{id:"_3-启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动"}},[t._v("#")]),t._v(" 3.启动")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 集群启动")]),t._v("\n./kafka-server-start.sh -daemon"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("/config/server0.properties\n./kafka-server-start.sh -daemon"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("/config/server1.properties\n./kafka-server-start.sh -daemon"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("/config/server2.properties\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("搭建完后通过查看 zk 中的 /brokers/ids 看是否启动成功")]),t._v(" "),s("h3",{attrs:{id:"springboot中使用kafka"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#springboot中使用kafka"}},[t._v("#")]),t._v(" Springboot中使用Kafka")]),t._v(" "),s("h4",{attrs:{id:"_1-导入依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-导入依赖"}},[t._v("#")]),t._v(" 1.导入依赖")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.kafka"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-kafka"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h4",{attrs:{id:"_2-配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置文件"}},[t._v("#")]),t._v(" 2.配置文件")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kafka")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bootstrap-servers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 172.16.253.38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9092")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("172.16.253.38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9093")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("172.16.253.38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9094")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("producer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ⽣产者")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("retries")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置⼤于0的值，则客户端会将发送失败的记录重新发送")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("batch-size")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16384")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("buffer-memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("33554432")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("acks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定消息key和消息体的编解码⽅式")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key-serializer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" org.apache.kafka.common.serialization.StringSerializer\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value-serializer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" org.apache.kafka.common.serialization.StringSerializer\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("consumer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("group\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enable-auto-commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("auto-offset-reset")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" earliest\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key-deserializer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" org.apache.kafka.common.serialization.StringDeserializer\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("value-deserializer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" org.apache.kafka.common.serialization.StringDeserializer\n        \t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max-poll-records")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v("\n \t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("listener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当每⼀条记录被消费者监听器（ListenerConsumer）处理之后提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RECORD")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当每⼀批 poll() 的数据被消费者监听器（ListenerConsumer）处理之后提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# BATCH")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当每⼀批poll()的数据被消费者监听器（ListenerConsumer）处理之后，距离上次提交时间⼤于TIME时提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# TIME")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当每⼀批poll()的数据被消费者监听器（ListenerConsumer）处理之后，被处理record数量⼤于等于COUNT时提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# COUNT")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# TIME | COUNT　有⼀个条件满⾜时提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# COUNT_TIME")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当每⼀批poll()的数据被消费者监听器（ListenerConsumer）处理之后, ⼿动调⽤Acknowledgment.acknowledge()后提交")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# MANUAL")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 手动调⽤Acknowledgment.acknowledge()后⽴即提交，⼀般使⽤这种")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# MANUAL_IMMEDIATE")]),t._v("\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ack-mode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MANUAL_IMMEDIATE\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br")])]),s("h4",{attrs:{id:"_3-生产者"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-生产者"}},[t._v("#")]),t._v(" 3.生产者")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("beans"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("factory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Autowired")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KafkaTemplate")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RequestMapping")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("web"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bind"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RestController")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RestController")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/msg"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KafkaController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOPIC_NAME")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my-replicated-topic"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n \t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KafkaTemplate")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" kafkaTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/send"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n \t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        kafkaTemplate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("TOPIC_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"this is a message!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"send success!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br")])]),s("h4",{attrs:{id:"_4-消费者"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-消费者"}},[t._v("#")]),t._v(" 4.消费者")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("consumer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConsumerRecord")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("apache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clients"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("consumer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConsumerRecords")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KafkaListener")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("support"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Acknowledgment")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token import"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stereotype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Consumer")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@KafkaListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topics "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my-replicated-topic"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("groupId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyGroup1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listenGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConsumerRecord")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Acknowledgment")]),t._v(" ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 手动提交offset")]),t._v("\n        ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acknowledge")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("p",[s("strong",[t._v("配置消费主题、分区和偏移量")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@KafkaListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("groupId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"testGroup"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" topicPartitions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@TopicPartition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topic "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" partitions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@TopicPartition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topic "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"topic2"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" partitions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    partitionOffsets "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \t"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PartitionOffset")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("partition "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" initialOffset "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"100"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("concurrency "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// concurrency 就是同组下的消费者个数，就是并发消费数，建议⼩于等于分区总数")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listenGroupPro")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ConsumerRecord")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Acknowledgment")]),t._v(" ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("record"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 手动提交offset")]),t._v("\n    ack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("acknowledge")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h3",{attrs:{id:"kafka集群controller、rebalance、hw"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka集群controller、rebalance、hw"}},[t._v("#")]),t._v(" Kafka集群Controller、Rebalance、HW")]),t._v(" "),s("h4",{attrs:{id:"_1-controller"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-controller"}},[t._v("#")]),t._v(" 1.Controller")]),t._v(" "),s("p",[t._v("kafka集群中broker在zookeeper上创建临时序号节点，序号最小的节点（即最先创建的节点）为集群的controller，负责管理整个集群所有分区和副本状态：")]),t._v(" "),s("ul",[s("li",[t._v("当某个分区中的leader副本出现故障，由控制器负责为该分区选举新的leader副本，选举的规则是从isr集合中最左边获取")]),t._v(" "),s("li",[t._v("当集群中有broker新增或减少，controller会同步信息给其他broker")]),t._v(" "),s("li",[t._v("当集群中有分区新增或减少，controller会同步信息给其他broker")])]),t._v(" "),s("h4",{attrs:{id:"_2-rebalance"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-rebalance"}},[t._v("#")]),t._v(" 2.Rebalance")]),t._v(" "),s("p",[t._v("如果消费者没有指明消费分区，就会触发rebalance机制，重新调整消费者该在哪个分区消费。")]),t._v(" "),s("p",[s("strong",[t._v("有三种策略：")])]),t._v(" "),s("ul",[s("li",[t._v("range：通过计算来寻找分区；前面的消费者："),s("code",[t._v("(分区总数/消费者数) + 1")]),t._v("，后面的消费者："),s("code",[t._v("分区总数/消费者数")])]),t._v(" "),s("li",[t._v("轮询")]),t._v(" "),s("li",[t._v("sticky：粘合策略；如果需要rebalance，那么之前分配的基础不变，进行调整；没开这个策略，就会全部重新分配**（建议开启）**")])]),t._v(" "),s("h4",{attrs:{id:"_3-leo和hw"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-leo和hw"}},[t._v("#")]),t._v(" 3.LEO和HW")]),t._v(" "),s("p",[s("code",[t._v("LEO（log-end-offset）")]),t._v("某个副本最后消息的消息位置，"),s("code",[t._v("HW")]),t._v("是已经完成同步的位置。消息写入broker时，且每个broker完成这条消息的同步后，"),s("code",[t._v("HW")]),t._v("才会发生改变；在这之前，消费者是消费不到这条消息，完成同步，"),s("code",[t._v("HW")]),t._v("更新消费者才能消费到，这样的目的是为了"),s("strong",[t._v("保证消息不被遗漏")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/kafka-hw.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"kafka线上问题优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kafka线上问题优化"}},[t._v("#")]),t._v(" Kafka线上问题优化")]),t._v(" "),s("h4",{attrs:{id:"_1-防止消息丢失"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-防止消息丢失"}},[t._v("#")]),t._v(" 1.防止消息丢失")]),t._v(" "),s("p",[s("strong",[t._v("生产者：")])]),t._v(" "),s("ol",[s("li",[t._v("开启同步")]),t._v(" "),s("li",[t._v("把ack设成1或-1，并设置同步的分区数>=2")])]),t._v(" "),s("p",[s("strong",[t._v("消费者：")])]),t._v(" "),s("ol",[s("li",[t._v("自动提交改为手动提交")])]),t._v(" "),s("h4",{attrs:{id:"_2-防止重复消费"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-防止重复消费"}},[t._v("#")]),t._v(" 2.防止重复消费")]),t._v(" "),s("ol",[s("li",[t._v("通过唯一主键或分布式锁来限制消费")])]),t._v(" "),s("h4",{attrs:{id:"_3-保证消息有序性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-保证消息有序性"}},[t._v("#")]),t._v(" 3.保证消息有序性")]),t._v(" "),s("p",[t._v("**生产者：**使用同步发送，ack设置成0")]),t._v(" "),s("p",[t._v("**消费者：**主题只设置一个分区，消费组只有一个消费组")]),t._v(" "),s("h4",{attrs:{id:"_4-解决消息积压"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-解决消息积压"}},[t._v("#")]),t._v(" 4.解决消息积压")]),t._v(" "),s("ul",[s("li",[t._v("事先：充分使用多线程，使得机器性能最佳；业务架构设计优化，提升业务层面消费性能")]),t._v(" "),s("li",[t._v("事中：临时扩容，创建多消费组多消费者，加快消费速度；创建一个消费者，另外建一个主题，配置多分区多消费者，该消费者将"),s("strong",[t._v("poll下来得消息不消费，而是转发新主题上")]),t._v("，再由新主题得消费者消费")])]),t._v(" "),s("h4",{attrs:{id:"_5-延时队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-延时队列"}},[t._v("#")]),t._v(" 5.延时队列")]),t._v(" "),s("p",[t._v("假设创建一个订单，30分钟未支付则取消订单")]),t._v(" "),s("ul",[s("li",[t._v("创建主题")]),t._v(" "),s("li",[t._v("消费者消费主题的消息")]),t._v(" "),s("li",[t._v("消费者消费消息时，判断消息的创建时间和当前时间是否超过30分钟\n"),s("ul",[s("li",[t._v("超过：修改订单状态为取消")]),t._v(" "),s("li",[t._v("没有超过：记录当前消息的offset，不再继续消费消息；等待1分钟，再次拉取该offset及之后的消息，继续判断")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);