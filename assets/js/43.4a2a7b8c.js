(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{456:function(t,v,a){"use strict";a.r(v);var s=a(1),e=Object(s.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h3",{attrs:{id:"什么是zookeeper"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#什么是zookeeper"}},[t._v("#")]),t._v(" 什么是zookeeper")]),t._v(" "),v("p",[t._v("zookeeper是一款为分布式架构提供服务的一款高可用软件，它为分布式计算提供了分布式配置、同步和注册服务；分布式应用可以基于它实现数据发布/订阅、负载均衡、命名服务、集群管理、master选举、分布式锁、分布式队列等功能。")]),t._v(" "),v("h3",{attrs:{id:"zookeeper的数据结构"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper的数据结构"}},[t._v("#")]),t._v(" zookeeper的数据结构")]),t._v(" "),v("p",[t._v("zk是以key-value的形式存储的，用"),v("code",[t._v("/")]),t._v("分割路径元素的。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/zknamespace.jpg",alt:""}})]),t._v(" "),v("h3",{attrs:{id:"cap理论"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#cap理论"}},[t._v("#")]),t._v(" CAP理论")]),t._v(" "),v("p",[v("code",[t._v("CAP")]),t._v("理论指对于分布式系统来说，仅能满足其中两点，即要嘛"),v("code",[t._v("CP")]),t._v("，要嘛"),v("code",[t._v("AP")]),t._v("：")]),t._v(" "),v("ul",[v("li",[t._v("C（一致性）")]),t._v(" "),v("li",[t._v("A（可用性）")]),t._v(" "),v("li",[t._v("P（分区容错性），分布式系统在网络分区时发生故障，仍需能够保证对外提供满足一致性、可用性的服务")])]),t._v(" "),v("p",[v("code",[t._v("zk")]),t._v("保证了"),v("code",[t._v("CP")]),t._v("，"),v("code",[t._v("eruka")]),t._v("保证了"),v("code",[t._v("AP")]),t._v("，"),v("code",[t._v("nacos")]),t._v("既可支持"),v("code",[t._v("CP")]),t._v("也可以支持"),v("code",[t._v("AP")]),t._v("。")]),t._v(" "),v("h3",{attrs:{id:"base理论"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#base理论"}},[t._v("#")]),t._v(" BASE理论")]),t._v(" "),v("ul",[v("li",[t._v("基本可用，分布式故障时，允许损失部分可用性（服务降级）")]),t._v(" "),v("li",[t._v("软引用，允许中间状态")]),t._v(" "),v("li",[t._v("最终一致性")])]),t._v(" "),v("p",[v("em",[v("strong",[t._v("备注")]),t._v("：中间状态指的是不同的data replication（数据备份节点）之间的")]),v("em",[t._v("数据更新出现延迟时")]),v("em",[t._v("的")]),v("em",[t._v("最终一致性")]),t._v("*")]),t._v(" "),v("p",[t._v("BASE理论是对CAP理论中的一致性和可用性进行权衡的一个结果。"),v("strong",[t._v("核心思想："),v("strong",[t._v("无法做到强一致性，但每个节点应用都应该根据自身的业务特点，达到最后的")]),t._v("最终一致性")])]),t._v(" "),v("h3",{attrs:{id:"znode数据结构"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#znode数据结构"}},[t._v("#")]),t._v(" Znode数据结构")]),t._v(" "),v("p",[v("code",[t._v("zk")]),t._v("中所有存储的数据都是由"),v("code",[t._v("znode")]),t._v("组成，并以key/value形式存储数据的。")]),t._v(" "),v("p",[v("code",[t._v("znode")]),t._v("的状态属性：")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("key")]),t._v(" "),v("th",[t._v("描述")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("cZxid")]),t._v(" "),v("td",[t._v("创建节点的事务id")])]),t._v(" "),v("tr",[v("td",[t._v("ctime")]),t._v(" "),v("td",[t._v("创建节点的时间")])]),t._v(" "),v("tr",[v("td",[t._v("mZxid")]),t._v(" "),v("td",[t._v("修改节点的事务id")])]),t._v(" "),v("tr",[v("td",[t._v("mtime")]),t._v(" "),v("td",[t._v("修改节点的时间")])]),t._v(" "),v("tr",[v("td",[t._v("pZid")]),t._v(" "),v("td",[t._v("该节点的子节点列表最后一次修改的事务id；"),v("strong",[t._v("子节点列表变更才会触发，修改子节点内容不触发")])])]),t._v(" "),v("tr",[v("td",[t._v("cversion")]),t._v(" "),v("td",[t._v("子节点版本号，子节点修改版本号+1")])]),t._v(" "),v("tr",[v("td",[t._v("dataversion")]),t._v(" "),v("td",[t._v("数据版本号，数据每次修改版本号+1")])]),t._v(" "),v("tr",[v("td",[t._v("aclversion")]),t._v(" "),v("td",[t._v("权限版本号")])]),t._v(" "),v("tr",[v("td",[t._v("ephemeralOwner")]),t._v(" "),v("td",[t._v("创建该临时节点的会话的sessionId")])]),t._v(" "),v("tr",[v("td",[t._v("dataLength")]),t._v(" "),v("td",[t._v("数据长度")])]),t._v(" "),v("tr",[v("td",[t._v("numChildren")]),t._v(" "),v("td",[t._v("子节点数量")])])])]),t._v(" "),v("h3",{attrs:{id:"session的基本原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#session的基本原理"}},[t._v("#")]),t._v(" Session的基本原理")]),t._v(" "),v("h4",{attrs:{id:"session的创建"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#session的创建"}},[t._v("#")]),t._v(" Session的创建")]),t._v(" "),v("ul",[v("li",[t._v("SessionId：会话id")]),t._v(" "),v("li",[t._v("Timeout：会话超时时间")]),t._v(" "),v("li",[t._v("TickTime：下次会话超时时间")]),t._v(" "),v("li",[t._v("isClosing：标记一个会话是否已经被关闭")])]),t._v(" "),v("h4",{attrs:{id:"session的状态"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#session的状态"}},[t._v("#")]),t._v(" Session的状态")]),t._v(" "),v("ol",[v("li",[t._v("connecting：连接中")]),t._v(" "),v("li",[t._v("connected：已连接")]),t._v(" "),v("li",[t._v("closed：已关闭")])]),t._v(" "),v("h4",{attrs:{id:"会话超时管理-分桶策略-会话激活"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#会话超时管理-分桶策略-会话激活"}},[t._v("#")]),t._v(" 会话超时管理（分桶策略+会话激活）")]),t._v(" "),v("p",[t._v("zookeeper的leader服务运行期间会对会话超时检查，时间间隔是 ExpirationInterval，单位是毫秒，默认值是 tickTime，每隔 tickTime 进行一次会话超时检查。")]),t._v(" "),v("p",[t._v("ExpirationTime 的计算方式：")]),t._v(" "),v("div",{staticClass:"language-sh line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-sh"}},[v("code",[t._v("ExpirationTime "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CurrentTime + SessionTimeout"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nExpirationTime "),v("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ExpirationTime / ExpirationInterval + "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" * ExpirationInterval"),v("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[t._v("1")]),v("br"),v("span",{staticClass:"line-number"},[t._v("2")]),v("br")])]),v("p",[t._v("在zookeeper运行期间，客户端会在会话超时过期范围内向服务器"),v("strong",[t._v("发送请求或者ping")]),t._v("，即"),v("strong",[t._v("心跳检测")]),t._v("完成会话"),v("strong",[t._v("激活")]),t._v("，从而来保持会话的有效性。")]),t._v(" "),v("p",[t._v("激活流程：")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/sessionHeart.png",alt:""}})]),t._v(" "),v("p",[t._v("激活后进行会话迁移：")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/sessionExpirationTime.png",alt:""}})]),t._v(" "),v("h3",{attrs:{id:"acl权限控制"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#acl权限控制"}},[t._v("#")]),t._v(" ACL权限控制")]),t._v(" "),v("h4",{attrs:{id:"acl命令行"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#acl命令行"}},[t._v("#")]),t._v(" "),v("code",[t._v("ACL")]),t._v("命令行")]),t._v(" "),v("ul",[v("li",[v("code",[t._v("getAcl")]),t._v("：获取某个节点的权限信息")]),t._v(" "),v("li",[v("code",[t._v("setAcl")]),t._v("：授权某个节点的权限信息")]),t._v(" "),v("li",[v("code",[t._v("addauth")]),t._v("：输入认证授权信息；注册时输入明文密码，存储为加密")])]),t._v(" "),v("h4",{attrs:{id:"acl权限"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#acl权限"}},[t._v("#")]),t._v(" "),v("code",[t._v("ACL")]),t._v("权限")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th",[t._v("ACL权限")]),t._v(" "),v("th",[t._v("ACL缩写")]),t._v(" "),v("th",[t._v("允许的操作")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("CREATE")]),t._v(" "),v("td",[t._v("c")]),t._v(" "),v("td",[t._v("创建子节点")])]),t._v(" "),v("tr",[v("td",[t._v("DELETE")]),t._v(" "),v("td",[t._v("d")]),t._v(" "),v("td",[t._v("删除子节点")])]),t._v(" "),v("tr",[v("td",[t._v("READ")]),t._v(" "),v("td",[t._v("r")]),t._v(" "),v("td",[t._v("获取节点数据和子节点")])]),t._v(" "),v("tr",[v("td",[t._v("WRITE")]),t._v(" "),v("td",[t._v("w")]),t._v(" "),v("td",[t._v("设置的节点数据")])]),t._v(" "),v("tr",[v("td",[t._v("ADMIN")]),t._v(" "),v("td",[t._v("a")]),t._v(" "),v("td",[t._v("设置acl权限")])])])]),t._v(" "),v("h4",{attrs:{id:"auth实例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#auth实例"}},[t._v("#")]),t._v(" "),v("code",[t._v("auth")]),t._v("实例")]),t._v(" "),v("div",{staticClass:"language-sh line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-sh"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建用户")]),t._v("\naddauth digest user1:123456\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 授权")]),t._v("\nsetAcl /test/child auth:user1:123456:cdrwa\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看节点授权信息")]),t._v("\ngetAcl /test/child\n")])]),t._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[t._v("1")]),v("br"),v("span",{staticClass:"line-number"},[t._v("2")]),v("br"),v("span",{staticClass:"line-number"},[t._v("3")]),v("br"),v("span",{staticClass:"line-number"},[t._v("4")]),v("br"),v("span",{staticClass:"line-number"},[t._v("5")]),v("br"),v("span",{staticClass:"line-number"},[t._v("6")]),v("br")])]),v("h4",{attrs:{id:"digest实例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#digest实例"}},[t._v("#")]),t._v(" "),v("code",[t._v("digest")]),t._v("实例")]),t._v(" "),v("p",[t._v("退出当前用户，重新连接终端，digest 可用于账号密码登录和验证")]),t._v(" "),v("div",{staticClass:"language-sh line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-sh"}},[v("code",[v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建节点")]),t._v("\ncreate /test/child "),v("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置权限")]),t._v("\nsetAcl /test/child digest:user1:userpassword:cdra\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 授权认证，用上一次创建的时候用户")]),t._v("\naddauth digest user1:123456\n"),v("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看节点授权信息")]),t._v("\ngetAcl /test/child\n")])]),t._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[t._v("1")]),v("br"),v("span",{staticClass:"line-number"},[t._v("2")]),v("br"),v("span",{staticClass:"line-number"},[t._v("3")]),v("br"),v("span",{staticClass:"line-number"},[t._v("4")]),v("br"),v("span",{staticClass:"line-number"},[t._v("5")]),v("br"),v("span",{staticClass:"line-number"},[t._v("6")]),v("br"),v("span",{staticClass:"line-number"},[t._v("7")]),v("br"),v("span",{staticClass:"line-number"},[t._v("8")]),v("br")])]),v("h4",{attrs:{id:"ip实例"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#ip实例"}},[t._v("#")]),t._v(" "),v("code",[t._v("ip")]),t._v("实例")]),t._v(" "),v("p",[t._v("限制"),v("code",[t._v("ip")]),t._v("地址访问权限，设置"),v("code",[t._v("ip")]),t._v("102有权限，则101就没有权限访问")]),t._v(" "),v("div",{staticClass:"language- line-numbers-mode"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[t._v("# 创建节点\ncreate /test/ip 0\n# 设置权限认证\nsetAcl /test/ip ip:192.168.10.102:cdrwa\n# 获取节点数据\nget /test/ip\n")])]),t._v(" "),v("div",{staticClass:"line-numbers-wrapper"},[v("span",{staticClass:"line-number"},[t._v("1")]),v("br"),v("span",{staticClass:"line-number"},[t._v("2")]),v("br"),v("span",{staticClass:"line-number"},[t._v("3")]),v("br"),v("span",{staticClass:"line-number"},[t._v("4")]),v("br"),v("span",{staticClass:"line-number"},[t._v("5")]),v("br"),v("span",{staticClass:"line-number"},[t._v("6")]),v("br")])]),v("h3",{attrs:{id:"数据同步"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据同步"}},[t._v("#")]),t._v(" 数据同步")]),t._v(" "),v("p",[v("code",[t._v("zookeeper")]),t._v("实现数据同步主要依赖"),v("code",[t._v("zab")]),t._v("协议，"),v("code",[t._v("zab")]),t._v("协议主要分为两个部分：")]),t._v(" "),v("ul",[v("li",[t._v("消息广播")]),t._v(" "),v("li",[t._v("崩溃恢复")])]),t._v(" "),v("h4",{attrs:{id:"消息广播"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#消息广播"}},[t._v("#")]),t._v(" 消息广播")]),t._v(" "),v("p",[v("code",[t._v("zookeeper")]),t._v("使用单一进行"),v("code",[t._v("leader")]),t._v("来接收和处理客户端请求，采用"),v("code",[t._v("zab")]),t._v("原子广播协议，向所有"),v("code",[t._v("follow")]),t._v("广播消息，超过半数的"),v("code",[t._v("follow")]),t._v("回应"),v("code",[t._v("ack")]),t._v("，"),v("code",[t._v("leader")]),t._v("会再次向所有"),v("code",[t._v("follow")]),t._v("发送"),v("code",[t._v("commit")]),t._v("消息，将此次提案提交，这个过程称为"),v("code",[t._v("2pc")]),t._v("事务提交。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://raw.githubusercontent.com/fighting-Yrj/blog-img/main/zk-data-stream-async.png",alt:""}})]),t._v(" "),v("h4",{attrs:{id:"崩溃恢复"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#崩溃恢复"}},[t._v("#")]),t._v(" 崩溃恢复")]),t._v(" "),v("p",[t._v("当"),v("code",[t._v("leader")]),t._v("服务崩溃或与半数以上"),v("code",[t._v("follow")]),t._v("失去通信，那么就会进入崩溃恢复模式，需要重新选举一个"),v("code",[t._v("leader")]),t._v("服务。")]),t._v(" "),v("p",[v("code",[t._v("zab")]),t._v("协议恢复模式策略：")]),t._v(" "),v("ul",[v("li",[t._v("选举"),v("code",[t._v("zxid")]),t._v("最大的节点作为"),v("code",[t._v("leader")])]),t._v(" "),v("li",[t._v("新"),v("code",[t._v("leader")]),t._v("将事务日志中未提交的消息进行处理")])]),t._v(" "),v("h3",{attrs:{id:"leader选举原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#leader选举原理"}},[t._v("#")]),t._v(" Leader选举原理")]),t._v(" "),v("h4",{attrs:{id:"选举状态"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#选举状态"}},[t._v("#")]),t._v(" 选举状态")]),t._v(" "),v("ul",[v("li",[t._v("LOOKING：竞选状态")]),t._v(" "),v("li",[t._v("FOLLOWING：随从状态。同步leader状态，参与选举")]),t._v(" "),v("li",[t._v("OBSERVING：观察状态。同步leader状态，参与不选举")]),t._v(" "),v("li",[t._v("LEADING：领导状态")])]),t._v(" "),v("h4",{attrs:{id:"选举重要参数"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#选举重要参数"}},[t._v("#")]),t._v(" 选举重要参数")]),t._v(" "),v("ol",[v("li",[t._v("myid：服务器id")]),t._v(" "),v("li",[t._v("zxid：事务id，越大代表数据越新")]),t._v(" "),v("li",[t._v("epoch-logicalclock：逻辑时钟，同一轮逻辑时钟相同，每投完一轮值增加")])]),t._v(" "),v("h4",{attrs:{id:"选举权重"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#选举权重"}},[t._v("#")]),t._v(" 选举权重")]),t._v(" "),v("ol",[v("li",[t._v("优先比较epoch")]),t._v(" "),v("li",[t._v("检查zxid")]),t._v(" "),v("li",[t._v("zxid相同看myid")])]),t._v(" "),v("h3",{attrs:{id:"分布式锁原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#分布式锁原理"}},[t._v("#")]),t._v(" 分布式锁原理")]),t._v(" "),v("h4",{attrs:{id:"排他锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#排他锁"}},[t._v("#")]),t._v(" 排他锁")]),t._v(" "),v("p",[t._v("根据"),v("code",[t._v("zk")]),t._v("的同级节点唯一性原则，c1客户端创建节点"),v("code",[t._v("/exclusive_lock/lock")]),t._v("；其他客户端创建该节点时会失败，这时可以给节点注册一个"),v("code",[t._v("watch")]),t._v("监听事件，当c1释放锁删除节点，watch监听到就可以去创建节点（争抢锁）")]),t._v(" "),v("h4",{attrs:{id:"共享锁"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#共享锁"}},[t._v("#")]),t._v(" 共享锁")]),t._v(" "),v("ol",[v("li",[t._v("客户端创建临时节点")]),t._v(" "),v("li",[t._v("获取所有子节点列表")]),t._v(" "),v("li",[t._v("判断是否获得锁，对于读请求，比自己序号小的都是读请求或者没有比自己序号小的，就获得锁；对于写请求，自己不是最小序号，就不能获得到锁")]),t._v(" "),v("li",[t._v("如果没有获得到共享锁，对于读请求，在向比自己小的"),v("strong",[t._v("最后一个写请求")]),t._v("注册监听器；对于写请求，在向比自己小的"),v("strong",[t._v("最后一个请求")]),t._v("注册监听器")])])])}),[],!1,null,null,null);v.default=e.exports}}]);